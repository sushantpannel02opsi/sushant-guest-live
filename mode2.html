
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Mode 2" />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" type="image/png" href="image/tiktokicon.png" />
  <link rel="apple-touch-icon" href="image/tiktokicon.png" />
  <link rel="manifest" href="manifest.json" />
 <script>
  if (localStorage.getItem("access_granted") !== "true") {
    window.location.replace("admin.html");
  }
</script>
  <title>Mode 2 ‚Äì Remote</title>
  <style>
    @font-face {
      font-family: "TikTok Sans";
      src: url("TikTok_Sans/static/TikTokSans-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    :root {
      color-scheme: dark light;
      --bg: #0f1115;
      --card: #161a21;
      --text: #e8ecf2;
      --muted: #8b93a6;
      --accent: #5dd1ff;
      --border: #232836;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "TikTok Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .card {
      background: rgba(22,26,33,0.85);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      width: min(520px, 100%);
      box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    }
    h1 { margin: 0 0 12px; }
    p { margin: 0 0 16px; color: var(--muted); }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .panel { margin-top: 16px; border-top: 1px solid var(--border); padding-top: 14px; }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
    .panel-body { display: grid; gap: 10px; max-height: 70vh; overflow-y: auto; padding-right: 4px; }
    .collapsible-body {
      transition: max-height 0.25s ease, padding-top 0.25s ease, padding-bottom 0.25s ease;
      overflow: hidden;
    }
    .collapsible-body[data-collapsed="true"] {
      max-height: 0 !important;
      padding-top: 0;
      padding-bottom: 0;
    }
    .preview-grid { display: grid; gap: 10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .seat {
      background: #14171c;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .seat:hover { border-color: var(--accent); box-shadow: 0 10px 24px rgba(93, 209, 255, 0.12); }
    .seat-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); background: #0b0f16; }
    .seat-name { font-weight: 700; font-size: 14px; color: var(--text); flex: 1; }
    .seat-action { padding: 6px 10px; border-radius: 10px; background: transparent; border: 1px solid var(--border); color: var(--text); cursor: pointer; }
    .seat-main { display: flex; align-items: center; gap: 10px; }
    .seat-actions { margin-left: auto; display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .seat-action.donate { border-color: #ff9a3c; background: linear-gradient(135deg, rgba(255,154,60,0.18), rgba(255,200,120,0.12)); }
    .gift-menu { display: flex; gap: 8px; flex-wrap: wrap; }
    .gift-menu[hidden] { display: none; }
    .gift-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1d232f;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .gift-item:hover { border-color: var(--accent); box-shadow: 0 10px 24px rgba(93, 209, 255, 0.12); }
    .gift-thumb { width: 36px; height: 36px; border-radius: 8px; object-fit: cover; background: #0b0f16; border: 1px solid var(--border); }
    .gift-name { font-weight: 700; font-size: 13px; color: var(--text); }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-weight: 700; font-size: 14px; color: var(--text); }
    .inline { display: flex; align-items: center; gap: 8px; }
    input[type="range"] { width: 100%; }
    input[type="color"] { width: 60px; height: 32px; border: 1px solid var(--border); border-radius: 8px; background: #000; }
    .num-input { width: 64px; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); background: #0b0f16; color: var(--text); }
    .icon-btn {
      min-width: 40px;
      padding: 6px 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button {
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(93, 209, 255, 0.18), rgba(155, 123, 255, 0.18));
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    button.secondary { background: transparent; }
    button:hover { box-shadow: 0 12px 28px rgba(93, 209, 255, 0.2); border-color: var(--accent); }
    button:active { transform: translateY(1px); }
    @media (max-width: 520px) {
      body { padding: 14px; }
      .card { padding: 16px; }
      .seat-main { flex-wrap: wrap; }
      .seat-actions { width: 100%; margin-left: 0; justify-content: flex-start; }
      .seat-action { flex: 1 1 auto; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Remote Control</h1>
    <p>Send commands to the host tab on the same origin.</p>
    <div class="actions">
      <button id="remoteOpen">Open 8-seat room</button>
      <button id="remoteStartCam">Start host camera</button>
      <button id="toggleEditMove" class="secondary">Edit Move: Off</button>
      <button id="saveLayout" class="secondary">Save Layout</button>
      <button id="resetLayout" class="secondary">Reset Layout</button>
      <button id="openHost" class="secondary">Open host tab</button>
    </div>

    <div class="panel" id="stylePanel">
      <div class="panel-header">
        <h2 style="margin:0;font-size:16px;">Edit 8-room style</h2>
        <button id="toggleStyle" class="secondary icon-btn" aria-label="Toggle 8-room style" title="Toggle 8-room style">‚öôÔ∏è ‚ñº</button>
      </div>
      <div class="panel-body collapsible-body" id="styleBody" data-collapsed="true" style="max-height:70vh;overflow-y:auto;">
        <div class="field">
          <label for="heightInput">Seat height (px)</label>
          <div class="inline">
            <input id="heightInput" type="range" min="80" max="220" value="101" />
            <input id="heightValue" class="num-input" type="number" min="80" max="220" value="101" />
          </div>
        </div>
        <div class="field">
          <label for="widthInput">Seat min width (px)</label>
          <div class="inline">
            <input id="widthInput" type="range" min="0" max="280" value="0" />
            <input id="widthValue" class="num-input" type="number" min="0" max="280" value="0" />
          </div>
        </div>
        <div class="field">
          <label for="gapInput">Gap between boxes (px)</label>
          <div class="inline">
            <input id="gapInput" type="range" min="0" max="32" value="5" />
            <input id="gapValue" class="num-input" type="number" min="0" max="32" value="5" />
          </div>
        </div>
        <div class="field">
          <label>Background colors</label>
          <div class="inline">
            <input id="color1" type="color" value="#14171c" aria-label="Base color" />
            <input id="color2" type="color" value="#1f2430" aria-label="Contrast color" />
          </div>
        </div>
        <div class="field">
          <label for="blendInput">Contrast mix (second color strength)</label>
          <div class="inline">
            <input id="blendInput" type="range" min="0" max="100" value="50" />
            <input id="blendValue" class="num-input" type="number" min="0" max="100" value="50" />
          </div>
        </div>
        <div class="field">
          <label for="plusSizeInput">Plus size (px)</label>
          <div class="inline">
            <input id="plusSizeInput" type="range" min="16" max="72" value="36" />
            <input id="plusSizeValue" class="num-input" type="number" min="16" max="72" value="36" />
          </div>
        </div>
        <div class="field">
          <label for="labelSizeInput">Request size (px)</label>
          <div class="inline">
            <input id="labelSizeInput" type="range" min="10" max="28" value="14" />
            <input id="labelSizeValue" class="num-input" type="number" min="10" max="28" value="14" />
          </div>
        </div>
        <div class="field">
          <label for="requestStyleSelect">Request text style</label>
          <select id="requestStyleSelect" class="num-input" style="width:100%;">
            <option value="regular">Regular</option>
            <option value="medium">Medium</option>
            <option value="semibold">SemiBold</option>
            <option value="bold">Bold</option>
            <option value="condensed">Condensed</option>
            <option value="expanded">Expanded</option>
          </select>
        </div>
        <div class="field">
          <label for="pointsFormatSelect">Seat points format</label>
          <select id="pointsFormatSelect" class="num-input" style="width:100%;">
            <option value="compact" selected>K/M</option>
            <option value="full">Full number</option>
          </select>
        </div>
        <div class="field">
          <label for="roomWidthInput">Room width (px)</label>
          <div class="inline">
            <input id="roomWidthInput" type="range" min="50" max="1600" value="215" />
            <input id="roomWidthValue" class="num-input" type="number" min="50" max="1600" value="215" />
          </div>
        </div>
        <div class="field">
          <label for="roomHeightInput">Room height (px)</label>
          <div class="inline">
            <input id="roomHeightInput" type="range" min="50" max="1200" value="423" />
            <input id="roomHeightValue" class="num-input" type="number" min="50" max="1200" value="423" />
          </div>
        </div>
        <div class="field">
          <label for="roomRadiusInput">8-seat border radius (px)</label>
          <div class="inline">
            <input id="roomRadiusInput" type="range" min="0" max="60" value="10" />
            <input id="roomRadiusValue" class="num-input" type="number" min="0" max="60" value="10" />
          </div>
        </div>
        <div class="field">
          <label for="roomXInput">Room offset X (px)</label>
          <div class="inline">
            <input id="roomXInput" type="range" min="-1000" max="1000" value="215" />
            <input id="roomXValue" class="num-input" type="number" min="-1000" max="1000" value="215" />
          </div>
        </div>
        <div class="field">
          <label for="roomYInput">Room offset Y (px)</label>
          <div class="inline">
            <input id="roomYInput" type="range" min="-1000" max="1000" value="165" />
            <input id="roomYValue" class="num-input" type="number" min="-1000" max="1000" value="165" />
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="camPanel">
      <div class="panel-header">
        <h2 style="margin:0;font-size:16px;">Edit Cam</h2>
        <button id="toggleCam" class="secondary icon-btn" aria-label="Toggle cam settings" title="Toggle cam settings">üì∑ ‚ñº</button>
      </div>
      <div class="panel-body collapsible-body" id="camBody" data-collapsed="true" style="max-height:70vh;overflow-y:auto;">
        <div class="field">
          <label for="camWidthInput">Cam width (px)</label>
          <div class="inline">
            <input id="camWidthInput" type="range" min="50" max="1600" value="212" />
            <input id="camWidthValue" class="num-input" type="number" min="50" max="1600" value="212" />
          </div>
        </div>
        <div class="field">
          <label for="camHeightInput">Cam height (px)</label>
          <div class="inline">
            <input id="camHeightInput" type="range" min="50" max="1200" value="420" />
            <input id="camHeightValue" class="num-input" type="number" min="50" max="1200" value="420" />
          </div>
        </div>
        <div class="field">
          <label for="camRadiusInput">Cam border radius (px)</label>
          <div class="inline">
            <input id="camRadiusInput" type="range" min="0" max="60" value="10" />
            <input id="camRadiusValue" class="num-input" type="number" min="0" max="60" value="10" />
          </div>
        </div>
        <div class="field">
          <label for="camXInput">Cam offset X (px)</label>
          <div class="inline">
            <input id="camXInput" type="range" min="-1000" max="1000" value="0" />
            <input id="camXValue" class="num-input" type="number" min="-1000" max="1000" value="0" />
          </div>
        </div>
        <div class="field">
          <label for="camYInput">Cam offset Y (px)</label>
          <div class="inline">
            <input id="camYInput" type="range" min="-1000" max="1000" value="0" />
            <input id="camYValue" class="num-input" type="number" min="-1000" max="1000" value="0" />
          </div>
        </div>
        <div class="field" style="margin-top:8px;">
          <label>Closed room cam</label>
          <div class="inline">
            <input id="closedCamWidthInput" type="range" min="50" max="2000" value="430" />
            <input id="closedCamWidthValue" class="num-input" type="number" min="50" max="2000" value="430" />
          </div>
          <div class="inline" style="margin-top:6px;">
            <input id="closedCamHeightInput" type="range" min="50" max="2000" value="615" />
            <input id="closedCamHeightValue" class="num-input" type="number" min="50" max="2000" value="615" />
          </div>
          <div class="inline" style="margin-top:6px;">
            <input id="closedCamXInput" type="range" min="-1500" max="1500" value="0" />
            <input id="closedCamXValue" class="num-input" type="number" min="-1500" max="1500" value="0" />
          </div>
          <div class="inline" style="margin-top:6px;">
            <input id="closedCamYInput" type="range" min="-1500" max="1500" value="165" />
            <input id="closedCamYValue" class="num-input" type="number" min="-1500" max="1500" value="165" />
          </div>
        </div>
        <div class="field">
          <label>Camera</label>
          <button id="toggleCamFacing" class="secondary" type="button" style="padding:8px 10px;">Switch front/back</button>
        </div>
        <div class="field">
          <label>Cam visibility</label>
          <button id="toggleCamVisible" class="secondary" type="button" style="padding:8px 10px;">Hide Cam</button>
        </div>
        <div class="field">
          <label>Host text</label>
          <button id="toggleHostText" class="secondary" type="button" style="padding:8px 10px;">Hide Host Text</button>
        </div>
        <div class="field">
          <label for="camNameInput">Cam name text (bottom-left)</label>
          <div class="inline">
            <input id="camNameInput" type="text" value="Host" placeholder="Enter cam name" style="flex:1;min-width:0;" />
            <button id="applyCamName" class="secondary" type="button" style="padding:8px 10px;">Apply</button>
          </div>
        </div>
        <div class="field">
          <label>Cam name visibility</label>
          <button id="toggleCamNameText" class="secondary" type="button" style="padding:8px 10px;">Hide Cam Name</button>
        </div>
        <div class="field">
          <label>Cam name capsule</label>
          <button id="toggleCamNameCapsule" class="secondary" type="button" style="padding:8px 10px;">Show Name Capsule</button>
        </div>
        <div class="field">
          <label>Cam tools on host</label>
          <button id="toggleCamTools" class="secondary" type="button" style="padding:8px 10px;">Show/Hide Cam Tools</button>
        </div>
        <div class="field">
          <label>VRM avatar</label>
          <button id="setDefaultVrm" class="secondary" type="button" style="padding:8px 10px;">Default VRM</button>
          <div class="inline" style="margin-top:8px;flex-wrap:wrap;gap:8px;">
            <button id="setVrm1" class="secondary" type="button" style="padding:8px 10px;">VRM 1</button>
            <button id="setVrm2" class="secondary" type="button" style="padding:8px 10px;">VRM 2</button>
          </div>
          <div class="field" style="margin-top:10px;">
            <label for="vrmPoseAngleInput">Custom hand angle</label>
            <div class="inline">
              <input id="vrmPoseAngleInput" type="range" min="0" max="360" value="100" />
              <input id="vrmPoseAngleValue" class="num-input" type="number" min="0" max="360" value="100" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="animationPanel">
      <div class="panel-header" style="gap:10px;">
        <h2 style="margin:0;font-size:16px;">Animation Box</h2>
        <button id="toggleAnimationBody" class="secondary icon-btn" aria-label="Toggle animation box settings" title="Toggle animation box settings">‚öôÔ∏è ‚ñº</button>
      </div>
      <div class="panel-body collapsible-body" id="animationBody" data-collapsed="true" style="max-height:70vh;overflow-y:auto;">
        <div class="field">
          <label for="animationWidthInput">Animation width (px)</label>
          <div class="inline">
            <input id="animationWidthInput" type="range" min="200" max="1600" value="700" />
            <input id="animationWidthValue" class="num-input" type="number" min="200" max="1600" value="700" />
          </div>
        </div>
        <div class="field">
          <label for="animationHeightInput">Animation height (px)</label>
          <div class="inline">
            <input id="animationHeightInput" type="range" min="150" max="1200" value="400" />
            <input id="animationHeightValue" class="num-input" type="number" min="150" max="1200" value="400" />
          </div>
        </div>
        <div class="field">
          <label for="animationXInput">Animation offset X (px)</label>
          <div class="inline">
            <input id="animationXInput" type="range" min="-1000" max="1000" value="350" />
            <input id="animationXValue" class="num-input" type="number" min="-1000" max="1000" value="350" />
          </div>
        </div>
        <div class="field">
          <label for="animationYInput">Animation offset Y (px)</label>
          <div class="inline">
            <input id="animationYInput" type="range" min="-1000" max="1000" value="350" />
            <input id="animationYValue" class="num-input" type="number" min="-1000" max="1000" value="350" />
          </div>
        </div>
        <button id="toggleAnimationBox" class="secondary" style="padding:8px 10px;">Show Border</button>
      </div>
    </div>

    <div class="panel" id="seatsPanel">
      <div class="panel-header" style="gap:10px;">
        <h2 style="margin:0;font-size:16px;">8-seat room</h2>
        <span id="roomStatus" style="color:var(--muted);font-size:13px;">Closed</span>
        <button id="toggleSeats" class="secondary" style="padding:6px 10px;margin-left:auto;">Hide</button>
      </div>
      <div id="previewGrid" class="preview-grid"></div>
    </div>
  </div>

  <script>
    /* ‚îÄ‚îÄ Single-instance guard: only one Mode 2 tab allowed ‚îÄ‚îÄ */
    (function() {
      const CHANNEL_NAME = 'mode2-single-instance';
      const instanceId = Date.now() + '-' + Math.random().toString(36).slice(2);
      const singleCh = new BroadcastChannel(CHANNEL_NAME);

      // Tell any existing Mode 2 tab to close
      singleCh.postMessage({ type: 'takeover', id: instanceId });

      singleCh.addEventListener('message', (e) => {
        if (e.data && e.data.type === 'takeover' && e.data.id !== instanceId) {
          // A newer Mode 2 tab opened ‚Äì close this one
          singleCh.close();
console.warn("portal redirect removed");        }
      });
    })();

    let ws = null;
    let wsRoomId = null;
    let layoutKey = "default";

    function getDisplayNameStorageKey(username) {
      return `tiktok-display-name:${String(username || 'default').toLowerCase()}`;
    }

    function getStoredDisplayName(username) {
      try {
        const value = localStorage.getItem(getDisplayNameStorageKey(username));
        return (value || '').trim() || 'Host';
      } catch (err) {
        return 'Host';
      }
    }

    function saveStoredDisplayName(username, value) {
      try {
        localStorage.setItem(getDisplayNameStorageKey(username), (value || '').trim() || 'Host');
      } catch (err) {
        // ignore
      }
    }

    function getWsUrl(roomId) {
      const proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
      return `${proto}://${window.location.host}/ws?room=${encodeURIComponent(roomId)}`;
    }

    function connectWs(roomId) {
      if (!roomId) return;
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
      ws = new WebSocket(getWsUrl(roomId));
      ws.addEventListener('message', (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleRemoteMessage(msg);
        } catch (err) {
          // ignore
        }
      });
      ws.addEventListener('close', () => {
        setTimeout(() => connectWs(roomId), 2000);
      });
    }

    function sendWs(message) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(message));
      }
    }

    async function requireLogin() {
      try {
        const res = await fetch('/api/auth/status', { credentials: 'include' });
        const data = await res.json();
        if (!res.ok || !data.authenticated) {
          window.location.href = 'portal.html';
          return;
        }
        wsRoomId = data.user?.username || null;
        layoutKey = wsRoomId || "default";
        const storedName = getStoredDisplayName(wsRoomId);
        const camNameEl = document.getElementById("camNameInput");
        if (camNameEl) camNameEl.value = storedName;
        connectWs(wsRoomId);
        sendMessage({ type: "cam-name-text", text: storedName });
        // Load layout for this user
        hydrateFromStore();
      } catch (err) {
console.warn("portal redirect removed");      }
    }
    requireLogin();

    const channelName = "tiktok-room-control";
    const channel = typeof BroadcastChannel !== "undefined" ? new BroadcastChannel(channelName) : null;
    const fallbackKey = "tiktok-room-control-message";
    const styleStoreKey = "tiktok-room-style-latest";
    const styleStoreVersion = 2;

    const defaultStyle = {
      slotHeight: 101,
      colWidth: 0,
      gap: 5,
      bg1: "#14171c",
      bg2: "#1f2430",
      blend: 0.5,
      plusSize: 36,
      labelSize: 14,
      requestTextStyle: "regular",
      pointsFormat: "compact",
      camWidth: 212,
      camHeight: 420,
      camRadius: 10,
      camOffsetX: 0,
      camOffsetY: 165,
      closedCamWidth: 430,
      closedCamHeight: 615,
      closedCamOffsetX: 0,
      closedCamOffsetY: 165,
      roomWidth: 215,
      roomHeight: 423,
      roomRadius: 10,
      roomOffsetX: 215,
      roomOffsetY: 165,
      animationWidth: 575,
      animationHeight: 566,
      animationOffsetX: -76,
      animationOffsetY: 379,
    };

    /* ---- Server-backed layout helpers ---- */
    async function loadLayoutFromServer() {
      try {
const res = await fetch(`http://localhost:8787/api/tiktok/profile/${encodeURIComponent(clean)}`);        const data = await resp.json();
        if (data.ok && data.style && typeof data.style === 'object') {
          return data.style;
        }
      } catch (err) { /* ignore */ }
      return null;
    }

    async function saveLayoutToServer(style) {
      try {
        await fetch('/api/layout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: layoutKey, style })
        });
      } catch (err) { /* ignore */ }
    }
    const transparentAvatar = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
    const giftOptions = [
           {
        id: "lion",
        name: "Lion Gift",
        img: "image/lion_img.png",
        animation: "image/lionAnimation.mp4",
        sources: ["image/lionAnimation.mp4", "image/lionAnimation.webm"],
      },
      {
        id: "leonandlion",
        name: "Leon and Lion",
        img: "image/leonandlion_img.png",
        animation: "image/!Leon and Lion (34000).webm",
        sources: ["image/!Leon and Lion (34000).webm"],
      },
      {
        id: "zeus",
        name: "Zeus",
        img: "image/zeusicon.png",
        animation: "image/!Zeus (34000).webm",
        sources: ["image/!Zeus (34000).webm"],
      },
      {
        id: "dragon",
        name: "Dragon",
        img: "image/dragonicon.png",
        animation: "image/dragonanimation.webm",
        sources: ["image/dragonanimation.webm"],
      },
      {
        id: "pegasus",
        name: "Pegasus Gift",
        img: "image/pegasus_img.png",
        animation: "image/pegasus.mp4",
        sources: ["image/pegasus.mp4"],
      },
      {
        id: "thunderfalcon",
        name: "Thunder Falcon",
        img: "image/thunderfalfon_img.jpeg",
        animation: "image/thunderfalcon.mp4",
        sources: ["image/thunderfalcon.mp4"],
      },
    ];
    // Allow overriding API host with ?api=http://yourhost:port, default to same origin.
    const apiOverride = new URLSearchParams(window.location.search).get("api");
    const apiGuessBase = apiOverride ? apiOverride.replace(/\/$/, "") : window.location.origin;
    const profileEndpoints = [
      `${apiGuessBase}/api/tiktok/profile/`,
    ];

    const qs = new URLSearchParams(location.search);
    const preferredMode = qs.get("mode");

    const remoteOpenBtn = document.getElementById("remoteOpen");
    const remoteStartCamBtn = document.getElementById("remoteStartCam");
    const toggleEditMoveBtn = document.getElementById("toggleEditMove");
    const saveLayoutBtn = document.getElementById("saveLayout");
    const resetLayoutBtn = document.getElementById("resetLayout");
    const openHostBtn = document.getElementById("openHost");
    const toggleStyleBtn = document.getElementById("toggleStyle");
    const toggleAnimationBodyBtn = document.getElementById("toggleAnimationBody");
    const toggleCamBtn = document.getElementById("toggleCam");
    const styleBody = document.getElementById("styleBody");
    const camBody = document.getElementById("camBody");
    const previewGrid = document.getElementById("previewGrid");
    const roomStatus = document.getElementById("roomStatus");
    const toggleSeatsBtn = document.getElementById("toggleSeats");
    const heightInput = document.getElementById("heightInput");
    const widthInput = document.getElementById("widthInput");
    const gapInput = document.getElementById("gapInput");
    const color1 = document.getElementById("color1");
    const color2 = document.getElementById("color2");
    const blendInput = document.getElementById("blendInput");
    const plusSizeInput = document.getElementById("plusSizeInput");
    const labelSizeInput = document.getElementById("labelSizeInput");
    const requestStyleSelect = document.getElementById("requestStyleSelect");
    const pointsFormatSelect = document.getElementById("pointsFormatSelect");
    const camWidthInput = document.getElementById("camWidthInput");
    const camHeightInput = document.getElementById("camHeightInput");
    const camRadiusInput = document.getElementById("camRadiusInput");
    const camXInput = document.getElementById("camXInput");
    const camYInput = document.getElementById("camYInput");
    const roomWidthInput = document.getElementById("roomWidthInput");
    const roomHeightInput = document.getElementById("roomHeightInput");
    const roomRadiusInput = document.getElementById("roomRadiusInput");
    const roomXInput = document.getElementById("roomXInput");
    const roomYInput = document.getElementById("roomYInput");
    const heightValue = document.getElementById("heightValue");
    const widthValue = document.getElementById("widthValue");
    const gapValue = document.getElementById("gapValue");
    const blendValue = document.getElementById("blendValue");
    const plusSizeValue = document.getElementById("plusSizeValue");
    const labelSizeValue = document.getElementById("labelSizeValue");
    const camWidthValue = document.getElementById("camWidthValue");
    const camHeightValue = document.getElementById("camHeightValue");
    const camRadiusValue = document.getElementById("camRadiusValue");
    const camXValue = document.getElementById("camXValue");
    const camYValue = document.getElementById("camYValue");
    const closedCamWidthInput = document.getElementById("closedCamWidthInput");
    const closedCamHeightInput = document.getElementById("closedCamHeightInput");
    const closedCamXInput = document.getElementById("closedCamXInput");
    const closedCamYInput = document.getElementById("closedCamYInput");
    const closedCamWidthValue = document.getElementById("closedCamWidthValue");
    const closedCamHeightValue = document.getElementById("closedCamHeightValue");
    const closedCamXValue = document.getElementById("closedCamXValue");
    const closedCamYValue = document.getElementById("closedCamYValue");
    const roomWidthValue = document.getElementById("roomWidthValue");
    const roomHeightValue = document.getElementById("roomHeightValue");
    const roomRadiusValue = document.getElementById("roomRadiusValue");
    const roomXValue = document.getElementById("roomXValue");
    const roomYValue = document.getElementById("roomYValue");
    const animationWidthInput = document.getElementById("animationWidthInput");
    const animationHeightInput = document.getElementById("animationHeightInput");
    const animationXInput = document.getElementById("animationXInput");
    const animationYInput = document.getElementById("animationYInput");
    const animationWidthValue = document.getElementById("animationWidthValue");
    const animationHeightValue = document.getElementById("animationHeightValue");
    const animationXValue = document.getElementById("animationXValue");
    const animationYValue = document.getElementById("animationYValue");
    const toggleAnimationBoxBtn = document.getElementById("toggleAnimationBox");
    const toggleCamFacingBtn = document.getElementById("toggleCamFacing");
    const toggleCamVisibleBtn = document.getElementById("toggleCamVisible");
    const camNameInput = document.getElementById("camNameInput");
    const applyCamNameBtn = document.getElementById("applyCamName");
    const toggleCamNameTextBtn = document.getElementById("toggleCamNameText");
    const toggleCamNameCapsuleBtn = document.getElementById("toggleCamNameCapsule");
    const toggleCamToolsBtn = document.getElementById("toggleCamTools");
    const setDefaultVrmBtn = document.getElementById("setDefaultVrm");
    const setVrm1Btn = document.getElementById("setVrm1");
    const setVrm2Btn = document.getElementById("setVrm2");
    const vrmPoseAngleInput = document.getElementById("vrmPoseAngleInput");
    const vrmPoseAngleValue = document.getElementById("vrmPoseAngleValue");

    const seatsStoreKey = "tiktok-room-seats-v2";
    const seatCount = 8;
    let seats = Array.from({ length: seatCount }, () => null);
    let roomOpen = true;
    let openGiftMenu = null;
    let animationBoxVisible = false;
    let editMoveEnabled = false;
    let camVisible = true;

    function sendMessage(payload) {
      const message = { ...payload, ts: Date.now() };
      if (channel) {
        channel.postMessage(message);
      } else {
        localStorage.setItem(fallbackKey, JSON.stringify(message));
      }
      sendWs(message);
    }

    function handleRemoteMessage(msg) {
      if (!msg || typeof msg !== "object") return;
      if (msg.type === "remote-style" && msg.source && msg.source.startsWith("host")) {
        applyIncomingStyle(msg.style);
      }
      if (msg.type === "remote-command" && msg.action === "open-room") setRoomOpen(true);
      if (msg.type === "remote-command" && msg.action === "close-room") setRoomOpen(false);
    }

    function collectStyle() {
      return {
        slotHeight: Number(heightInput.value),
        colWidth: Number(widthInput.value),
        gap: Number(gapInput.value),
        bg1: color1.value,
        bg2: color2.value,
        blend: Number(blendInput.value) / 100,
        plusSize: Number(plusSizeInput.value),
        labelSize: Number(labelSizeInput.value),
        requestTextStyle: requestStyleSelect?.value || "regular",
        pointsFormat: pointsFormatSelect?.value || "compact",
        camWidth: Number(camWidthInput.value),
        camHeight: Number(camHeightInput.value),
        camRadius: Number(camRadiusInput.value),
        camOffsetX: Number(camXInput.value),
        camOffsetY: Number(camYInput.value),
        closedCamWidth: Number(closedCamWidthInput.value),
        closedCamHeight: Number(closedCamHeightInput.value),
        closedCamOffsetX: Number(closedCamXInput.value),
        closedCamOffsetY: Number(closedCamYInput.value),
        roomWidth: Number(roomWidthInput.value),
        roomHeight: Number(roomHeightInput.value),
        roomRadius: Number(roomRadiusInput.value),
        roomOffsetX: Number(roomXInput.value),
        roomOffsetY: Number(roomYInput.value),
        animationWidth: Number(animationWidthInput.value),
        animationHeight: Number(animationHeightInput.value),
        animationOffsetX: Number(animationXInput.value),
        animationOffsetY: Number(animationYInput.value),
      };
    }

    function loadStoredStyle() {
      try {
        const saved = localStorage.getItem(styleStoreKey);
        if (!saved) return null;
        const parsed = JSON.parse(saved);
        if (!parsed || typeof parsed !== "object") return null;
        if (parsed._v !== styleStoreVersion) return null;
        const { _v, ...rest } = parsed;
        return rest;
      } catch (err) {
        return null;
      }
    }

    function broadcastStyle() {
      const merged = { ...(loadStoredStyle() || {}), ...collectStyle() };
      try { localStorage.setItem(styleStoreKey, JSON.stringify({ ...merged, _v: styleStoreVersion })); } catch (err) { /* ignore */ }
      const style = merged;
      sendMessage({ type: "remote-style", style });
    }

    async function resetLayoutToDefaults() {
      hydrateSliders(defaultStyle);
      broadcastStyle();
      const style = { ...collectStyle(), _v: styleStoreVersion };
      await saveLayoutToServer(style);
      sendMessage({ type: "save-layout" });
    }

    function saveSeats() {
      try { localStorage.setItem(seatsStoreKey, JSON.stringify(seats)); } catch (err) { /* ignore */ }
    }

    function loadSeats() {
      try {
        const saved = localStorage.getItem(seatsStoreKey);
        if (!saved) return;
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed) && parsed.length === seatCount) seats = parsed;
      } catch (err) { /* ignore */ }
    }

    function normalizeHandle(raw) {
      if (!raw) return "";
      const cleaned = raw.trim().replace(/^@+/, "");
      return cleaned;
    }

    async function fetchTikTokProfile(rawHandle) {
      const clean = normalizeHandle(rawHandle);
      if (!clean) return null;
      for (const base of profileEndpoints) {
        const url = `${base}${encodeURIComponent(clean)}`;
        try {
          const res = await fetch(url, { headers: { Accept: "application/json" } });
          if (!res.ok) throw new Error(`lookup failed ${res.status}`);
          const body = await res.json();
          const data = body?.data || body?.profile || body;
          if (!data) throw new Error("no profile payload");
          const username = data.username || data.uniqueId || clean;
          const display = data.nickname || data.displayName || username || clean;
          const avatar = data.avatar || data.avatarLarger || data.avatarThumb || "";
          return {
            handle: username.startsWith("@") ? username : "@" + username,
            name: display,
            avatar,
            followers: data.followers ?? data.followerCount,
            likes: data.likes ?? data.likesCount,
          };
        } catch (err) {
          console.warn("TikTok lookup failed", url, err);
        }
      }
      return {
        handle: "@" + clean,
        name: "@" + clean,
        avatar: "",
      };
    }

    function broadcastSeats() {
      saveSeats();
      sendMessage({ type: "remote-seats", seats });
    }

    function sendGift(giftId) {
      sendMessage({ type: "play-gift", giftId });
    }

    function toggleAnimationBoxVisibility() {
      animationBoxVisible = !animationBoxVisible;
      toggleAnimationBoxBtn.textContent = animationBoxVisible ? "Hide Border" : "Show Border";
      sendMessage({ type: "animation-box-visibility", visible: animationBoxVisible });
    }

    function closeActiveGiftMenu() {
      if (openGiftMenu) {
        openGiftMenu.setAttribute("hidden", "hidden");
        openGiftMenu = null;
      }
    }

    function initChannel() {
      // No listeners needed here; remote only sends
      sendMessage({ type: "hello" });
    }

    function setRoomOpen(next) {
      roomOpen = next;
      roomStatus.textContent = next ? "Open" : "Closed";
      remoteOpenBtn.textContent = next ? "Close 8-seat room" : "Open 8-seat room";
      sendMessage({ type: "remote-command", action: next ? "open-room" : "close-room" });
    }

    remoteOpenBtn.addEventListener("click", () => {
      setRoomOpen(!roomOpen);
    });

    remoteStartCamBtn.addEventListener("click", () => {
      sendMessage({ type: "remote-command", action: "start-camera" });
    });

    if (toggleEditMoveBtn) {
      toggleEditMoveBtn.addEventListener("click", () => {
        editMoveEnabled = !editMoveEnabled;
        toggleEditMoveBtn.textContent = editMoveEnabled ? "Edit Move: On" : "Edit Move: Off";
        sendMessage({ type: "edit-mode", enabled: editMoveEnabled });
      });
    }

    if (saveLayoutBtn) {
      saveLayoutBtn.addEventListener("click", async () => {
        sendMessage({ type: "save-layout" });
        // Also save directly from mode2's current slider values
        const style = { ...collectStyle(), _v: styleStoreVersion };
        await saveLayoutToServer(style);
        console.log("Layout saved to server from mode2");
      });
    }

    if (resetLayoutBtn) {
      resetLayoutBtn.addEventListener("click", () => {
        resetLayoutToDefaults();
      });
    }

    openHostBtn.addEventListener("click", () => {
      window.open("mode1.html?mode=host", "_blank");
    });

    document.addEventListener("click", (e) => {
      if (!openGiftMenu) return;
      if (!openGiftMenu.contains(e.target)) {
        closeActiveGiftMenu();
      }
    });

    toggleSeatsBtn.addEventListener("click", () => {
      const hidden = previewGrid.hasAttribute("hidden");
      if (hidden) {
        previewGrid.removeAttribute("hidden");
        toggleSeatsBtn.textContent = "Hide";
      } else {
        previewGrid.setAttribute("hidden", "hidden");
        toggleSeatsBtn.textContent = "Show";
      }
    });

    toggleStyleBtn.addEventListener("click", () => {
      const collapsed = styleBody.getAttribute("data-collapsed") === "true";
      styleBody.setAttribute("data-collapsed", collapsed ? "false" : "true");
      toggleStyleBtn.textContent = collapsed ? "‚öôÔ∏è ‚ñ≤" : "‚öôÔ∏è ‚ñº";
    });

    toggleCamBtn.addEventListener("click", () => {
      const collapsed = camBody.getAttribute("data-collapsed") === "true";
      camBody.setAttribute("data-collapsed", collapsed ? "false" : "true");
      toggleCamBtn.textContent = collapsed ? "üì∑ ‚ñ≤" : "üì∑ ‚ñº";
    });

    toggleAnimationBodyBtn.addEventListener("click", () => {
      const collapsed = animationBody.getAttribute("data-collapsed") === "true";
      animationBody.setAttribute("data-collapsed", collapsed ? "false" : "true");
      toggleAnimationBodyBtn.textContent = collapsed ? "‚öôÔ∏è ‚ñ≤" : "‚öôÔ∏è ‚ñº";
    });

    toggleAnimationBoxBtn.addEventListener("click", () => {
      toggleAnimationBoxVisibility();
    });

    if (toggleCamFacingBtn) {
      toggleCamFacingBtn.addEventListener("click", () => {
        sendMessage({ type: "toggle-camera" });
      });
    }

    if (toggleCamVisibleBtn) {
      toggleCamVisibleBtn.addEventListener("click", () => {
        camVisible = !camVisible;
        toggleCamVisibleBtn.textContent = camVisible ? "Hide Cam" : "Show Cam";
        sendMessage({ type: "cam-visibility", visible: camVisible });
      });
    }

    let hostTextVisible = true;
    const toggleHostTextBtn = document.getElementById("toggleHostText");
    if (toggleHostTextBtn) {
      toggleHostTextBtn.addEventListener("click", () => {
        hostTextVisible = !hostTextVisible;
        toggleHostTextBtn.textContent = hostTextVisible ? "Hide Host Text" : "Show Host Text";
        sendMessage({ type: "host-text-visibility", visible: hostTextVisible });
      });
    }

    function sendCamNameText() {
      const nextText = (camNameInput?.value || "").trim() || "Host";
      saveStoredDisplayName(wsRoomId, nextText);
      sendMessage({ type: "cam-name-text", text: nextText });
    }

    if (applyCamNameBtn) {
      applyCamNameBtn.addEventListener("click", () => {
        sendCamNameText();
      });
    }

    if (camNameInput) {
      camNameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendCamNameText();
        }
      });
    }

    let camNameTextVisible = true;
    if (toggleCamNameTextBtn) {
      toggleCamNameTextBtn.addEventListener("click", () => {
        camNameTextVisible = !camNameTextVisible;
        toggleCamNameTextBtn.textContent = camNameTextVisible ? "Hide Cam Name" : "Show Cam Name";
        sendMessage({ type: "cam-name-visibility", visible: camNameTextVisible });
      });
    }

    let camNameCapsuleVisible = false;
    if (toggleCamNameCapsuleBtn) {
      toggleCamNameCapsuleBtn.addEventListener("click", () => {
        camNameCapsuleVisible = !camNameCapsuleVisible;
        toggleCamNameCapsuleBtn.textContent = camNameCapsuleVisible ? "Hide Name Capsule" : "Show Name Capsule";
        sendMessage({ type: "cam-name-capsule-visibility", visible: camNameCapsuleVisible });
      });
    }

    let camToolsVisible = false;
    if (toggleCamToolsBtn) {
      toggleCamToolsBtn.addEventListener("click", () => {
        camToolsVisible = !camToolsVisible;
        toggleCamToolsBtn.textContent = camToolsVisible ? "Hide Cam Tools" : "Show Cam Tools";
        sendMessage({ type: "cam-tools", visible: camToolsVisible });
      });
    }

    if (setDefaultVrmBtn) {
      setDefaultVrmBtn.addEventListener("click", () => {
        sendMessage({ type: "vrm-default" });
      });
    }

    if (setVrm1Btn) {
      setVrm1Btn.addEventListener("click", () => {
        sendMessage({ type: "vrm-load", url: "vrm/test.vrm" });
      });
    }

    if (setVrm2Btn) {
      setVrm2Btn.addEventListener("click", () => {
        sendMessage({ type: "vrm-load", url: "vrm/test.vrm" });
      });
    }

    function syncVrmPoseAngle(nextValue) {
      const safeValue = Number(nextValue);
      if (!Number.isFinite(safeValue)) return;
      if (vrmPoseAngleInput) vrmPoseAngleInput.value = String(safeValue);
      if (vrmPoseAngleValue) vrmPoseAngleValue.value = String(safeValue);
      sendMessage({ type: "vrm-pose-angle", angle: safeValue });
    }

    if (vrmPoseAngleInput) {
      vrmPoseAngleInput.addEventListener("input", (e) => {
        syncVrmPoseAngle(e.target.value);
      });
    }

    if (vrmPoseAngleValue) {
      vrmPoseAngleValue.addEventListener("change", (e) => {
        syncVrmPoseAngle(e.target.value);
      });
    }

    // Style controls
    function syncLabels() {
      heightValue.value = heightInput.value;
      widthValue.value = widthInput.value;
      gapValue.value = gapInput.value;
      blendValue.value = blendInput.value;
      plusSizeValue.value = plusSizeInput.value;
      labelSizeValue.value = labelSizeInput.value;
      camWidthValue.value = camWidthInput.value;
      camHeightValue.value = camHeightInput.value;
      camRadiusValue.value = camRadiusInput.value;
      camXValue.value = camXInput.value;
      camYValue.value = camYInput.value;
      closedCamWidthValue.value = closedCamWidthInput.value;
      closedCamHeightValue.value = closedCamHeightInput.value;
      closedCamXValue.value = closedCamXInput.value;
      closedCamYValue.value = closedCamYInput.value;
      roomWidthValue.value = roomWidthInput.value;
      roomHeightValue.value = roomHeightInput.value;
      roomRadiusValue.value = roomRadiusInput.value;
      roomXValue.value = roomXInput.value;
      roomYValue.value = roomYInput.value;
      animationWidthValue.value = animationWidthInput.value;
      animationHeightValue.value = animationHeightInput.value;
      animationXValue.value = animationXInput.value;
      animationYValue.value = animationYInput.value;
    }

    function applyPreviewStyle() {
      const style = collectStyle();
      previewGrid.style.gridTemplateColumns = `repeat(2, minmax(${style.colWidth}px, 1fr))`;
      previewGrid.style.gap = `${style.gap}px`;
      const mix = Math.min(1, Math.max(0, style.blend ?? 0.5));
      const cut = Math.round((1 - mix) * 70);
      const gradient = style.bg2
        ? `linear-gradient(135deg, ${style.bg1} 0%, ${style.bg1} ${cut}%, ${style.bg2} 100%)`
        : style.bg1;
      previewGrid.querySelectorAll(".seat").forEach((seatEl) => {
        seatEl.style.minHeight = `${style.slotHeight}px`;
        seatEl.style.borderRadius = `${style.roomRadius}px`;
        seatEl.style.background = gradient;
        const nameEl = seatEl.querySelector(".seat-name");
        if (nameEl) nameEl.style.fontSize = `${style.labelSize}px`;
      });
    }

    function renderSeatsPreview() {
      closeActiveGiftMenu();
      previewGrid.innerHTML = "";
      seats.forEach((seat, idx) => {
        const seatEl = document.createElement("div");
        seatEl.className = "seat";
        seatEl.dataset.index = idx;
        const seatMain = document.createElement("div");
        seatMain.className = "seat-main";
        const avatar = document.createElement("img");
        avatar.className = "seat-avatar";
        avatar.src = seat?.avatar || transparentAvatar;
        avatar.alt = seat?.handle || "";
        avatar.style.display = seat?.avatar ? "block" : "none";
        const name = document.createElement("div");
        name.className = "seat-name";
        name.textContent = seat?.name || "Empty";
        const actionsWrap = document.createElement("div");
        actionsWrap.className = "seat-actions";
        const action = document.createElement("button");
        action.className = "seat-action";
        action.textContent = seat ? "Kick" : "Add";
        action.type = "button";
        actionsWrap.append(action);

        const giftMenu = document.createElement("div");
        giftMenu.className = "gift-menu";
        giftMenu.setAttribute("hidden", "hidden");

        if (seat) {
          const donateBtn = document.createElement("button");
          donateBtn.className = "seat-action donate";
          donateBtn.textContent = "Donate";
          donateBtn.type = "button";
          donateBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const alreadyOpen = openGiftMenu === giftMenu;
            closeActiveGiftMenu();
            if (!alreadyOpen) {
              giftMenu.removeAttribute("hidden");
              openGiftMenu = giftMenu;
            }
          });
          actionsWrap.append(donateBtn);

          giftOptions.forEach((gift) => {
            const item = document.createElement("button");
            item.type = "button";
            item.className = "gift-item";
            const thumb = document.createElement("img");
            thumb.className = "gift-thumb";
            thumb.src = gift.img;
            thumb.alt = gift.name;
            const label = document.createElement("span");
            label.className = "gift-name";
            label.textContent = gift.name;
            item.append(thumb, label);
            item.addEventListener("click", (e) => {
              e.stopPropagation();
              if (gift.id === "lion" && seats[idx]) {
                const delta = 29999;
                const currentPoints = Number(seats[idx].points);
                const nextPoints = (Number.isFinite(currentPoints) ? currentPoints : 0) + delta;
                seats[idx].points = nextPoints;
                saveSeats();
                sendMessage({
                  type: "donate-gift",
                  giftId: gift.id,
                  seatIndex: idx,
                  seatHandle: seats[idx]?.handle || null,
                  pointsDelta: delta,
                  points: nextPoints,
                });
              } else if (gift.id === "leonandlion" && seats[idx]) {
                const delta = 34000;
                const currentPoints = Number(seats[idx].points);
                const nextPoints = (Number.isFinite(currentPoints) ? currentPoints : 0) + delta;
                seats[idx].points = nextPoints;
                saveSeats();
                sendMessage({
                  type: "donate-gift",
                  giftId: gift.id,
                  seatIndex: idx,
                  seatHandle: seats[idx]?.handle || null,
                  pointsDelta: delta,
                  points: nextPoints,
                });
              } else if (gift.id === "zeus" && seats[idx]) {
                const delta = 34000;
                const currentPoints = Number(seats[idx].points);
                const nextPoints = (Number.isFinite(currentPoints) ? currentPoints : 0) + delta;
                seats[idx].points = nextPoints;
                saveSeats();
                sendMessage({
                  type: "donate-gift",
                  giftId: gift.id,
                  seatIndex: idx,
                  seatHandle: seats[idx]?.handle || null,
                  pointsDelta: delta,
                  points: nextPoints,
                });
              } else if (gift.id === "dragon" && seats[idx]) {
                const delta = 26999;
                const currentPoints = Number(seats[idx].points);
                const nextPoints = (Number.isFinite(currentPoints) ? currentPoints : 0) + delta;
                seats[idx].points = nextPoints;
                saveSeats();
                sendMessage({
                  type: "donate-gift",
                  giftId: gift.id,
                  seatIndex: idx,
                  seatHandle: seats[idx]?.handle || null,
                  pointsDelta: delta,
                  points: nextPoints,
                });
              } else if (gift.id === "pegasus" && seats[idx]) {
                const delta = 42999;
                const currentPoints = Number(seats[idx].points);
                const nextPoints = (Number.isFinite(currentPoints) ? currentPoints : 0) + delta;
                seats[idx].points = nextPoints;
                saveSeats();
                sendMessage({
                  type: "donate-gift",
                  giftId: gift.id,
                  seatIndex: idx,
                  seatHandle: seats[idx]?.handle || null,
                  pointsDelta: delta,
                  points: nextPoints,
                });
              } else if (gift.id === "thunderfalcon" && seats[idx]) {
                const delta = 39999;
                const currentPoints = Number(seats[idx].points);
                const nextPoints = (Number.isFinite(currentPoints) ? currentPoints : 0) + delta;
                seats[idx].points = nextPoints;
                saveSeats();
                sendMessage({
                  type: "donate-gift",
                  giftId: gift.id,
                  seatIndex: idx,
                  seatHandle: seats[idx]?.handle || null,
                  pointsDelta: delta,
                  points: nextPoints,
                });
              } else {
                sendGift(gift.id);
              }
              closeActiveGiftMenu();
              broadcastSeats();
            });
            giftMenu.appendChild(item);
          });
        }

        seatMain.append(avatar, name, actionsWrap);
        seatEl.append(seatMain, giftMenu);

        seatEl.addEventListener("click", async () => {
          const current = seats[idx];
          const input = prompt("Enter TikTok handle (with or without @). Leave blank to clear:", current?.handle || "");
          if (input === null) return;
          const clean = normalizeHandle(input);
          if (!clean) {
            seats[idx] = null;
          } else {
            // Immediately clear the seat on the host so the old profile can't flash.
            // Then fetch the real profile and update again.
            seats[idx] = {
              handle: "@" + clean,
              name: "@" + clean,
              avatar: "",
              followers: null,
              likes: null,
              points: 0,
            };

            renderSeatsPreview();
            applyPreviewStyle();
            broadcastSeats();

            (async () => {
              const profile = await fetchTikTokProfile(clean);
              if (!profile) return;
              // Race safety: only apply if the seat still has the same handle.
              if (!seats[idx] || normalizeHandle(seats[idx].handle) !== clean) return;
              seats[idx] = { ...profile, points: 0 };
              renderSeatsPreview();
              applyPreviewStyle();
              broadcastSeats();
            })();
          }
          renderSeatsPreview();
          applyPreviewStyle();
          broadcastSeats();
        });

        action.addEventListener("click", (e) => {
          e.stopPropagation();
          if (seats[idx]) {
            seats[idx] = null;
            renderSeatsPreview();
            applyPreviewStyle();
            broadcastSeats();
          } else {
            const input = prompt("Enter TikTok handle (with or without @).", "");
            if (input === null) return;
            const clean = normalizeHandle(input);
            if (!clean) return;
            fetchTikTokProfile(clean).then((profile) => {
              seats[idx] = profile || {
                handle: "@" + clean,
                name: "@" + clean,
                avatar: "",
              };
              if (seats[idx]) seats[idx].points = 0;
              renderSeatsPreview();
              applyPreviewStyle();
              broadcastSeats();
            });
          }
        });
        previewGrid.appendChild(seatEl);
      });
      applyPreviewStyle();
    }

    function clamp(val, min, max) {
      const num = Number(val);
      if (Number.isNaN(num)) return min;
      return Math.min(max, Math.max(min, num));
    }

    function hydrateFromStore() {
      // Try server first, then fall back to localStorage
      loadLayoutFromServer().then(serverStyle => {
        const style = serverStyle || loadStoredStyle();
        if (!style) return;
        hydrateSliders(style);
      });
    }

    function hydrateSliders(style) {
      if (!style) return;
      const setters = [
        [heightInput, style.slotHeight],
        [widthInput, style.colWidth],
        [gapInput, style.gap],
        [color1, style.bg1],
        [color2, style.bg2],
        [blendInput, style.blend != null ? style.blend * 100 : undefined],
        [plusSizeInput, style.plusSize],
        [labelSizeInput, style.labelSize],
        [requestStyleSelect, style.requestTextStyle],
        [pointsFormatSelect, style.pointsFormat],
        [camWidthInput, style.camWidth],
        [camHeightInput, style.camHeight],
        [camRadiusInput, style.camRadius],
        [camXInput, style.camOffsetX],
        [camYInput, style.camOffsetY],
        [closedCamWidthInput, style.closedCamWidth],
        [closedCamHeightInput, style.closedCamHeight],
        [closedCamXInput, style.closedCamOffsetX],
        [closedCamYInput, style.closedCamOffsetY],
        [roomWidthInput, style.roomWidth],
        [roomHeightInput, style.roomHeight],
        [roomRadiusInput, style.roomRadius],
        [roomXInput, style.roomOffsetX],
        [roomYInput, style.roomOffsetY],
        [animationWidthInput, style.animationWidth],
        [animationHeightInput, style.animationHeight],
        [animationXInput, style.animationOffsetX],
        [animationYInput, style.animationOffsetY],
      ];
      setters.forEach(([el, val]) => {
        if (el && val != null) el.value = val;
      });
      syncLabels();
      renderSeatsPreview();
    }

    function applyIncomingStyle(style) {
      if (!style || typeof style !== "object") return;
      hydrateSliders(style);
      try { localStorage.setItem(styleStoreKey, JSON.stringify({ ...(loadStoredStyle() || {}), ...style, _v: styleStoreVersion })); } catch (err) { /* ignore */ }
    }

    function syncFromNumber() {
      heightInput.value = clamp(heightValue.value, Number(heightInput.min), Number(heightInput.max));
      widthInput.value = clamp(widthValue.value, Number(widthInput.min), Number(widthInput.max));
      gapInput.value = clamp(gapValue.value, Number(gapInput.min), Number(gapInput.max));
      blendInput.value = clamp(blendValue.value, Number(blendInput.min), Number(blendInput.max));
      plusSizeInput.value = clamp(plusSizeValue.value, Number(plusSizeInput.min), Number(plusSizeInput.max));
      labelSizeInput.value = clamp(labelSizeValue.value, Number(labelSizeInput.min), Number(labelSizeInput.max));
      camWidthInput.value = clamp(camWidthValue.value, Number(camWidthInput.min), Number(camWidthInput.max));
      camHeightInput.value = clamp(camHeightValue.value, Number(camHeightInput.min), Number(camHeightInput.max));
      camRadiusInput.value = clamp(camRadiusValue.value, Number(camRadiusInput.min), Number(camRadiusInput.max));
      camXInput.value = clamp(camXValue.value, Number(camXInput.min), Number(camXInput.max));
      camYInput.value = clamp(camYValue.value, Number(camYInput.min), Number(camYInput.max));
      closedCamWidthInput.value = clamp(closedCamWidthValue.value, Number(closedCamWidthInput.min), Number(closedCamWidthInput.max));
      closedCamHeightInput.value = clamp(closedCamHeightValue.value, Number(closedCamHeightInput.min), Number(closedCamHeightInput.max));
      closedCamXInput.value = clamp(closedCamXValue.value, Number(closedCamXInput.min), Number(closedCamXInput.max));
      closedCamYInput.value = clamp(closedCamYValue.value, Number(closedCamYInput.min), Number(closedCamYInput.max));
      roomWidthInput.value = clamp(roomWidthValue.value, Number(roomWidthInput.min), Number(roomWidthInput.max));
      roomHeightInput.value = clamp(roomHeightValue.value, Number(roomHeightInput.min), Number(roomHeightInput.max));
      roomRadiusInput.value = clamp(roomRadiusValue.value, Number(roomRadiusInput.min), Number(roomRadiusInput.max));
      roomXInput.value = clamp(roomXValue.value, Number(roomXInput.min), Number(roomXInput.max));
      roomYInput.value = clamp(roomYValue.value, Number(roomYInput.min), Number(roomYInput.max));
      animationWidthInput.value = clamp(animationWidthValue.value, Number(animationWidthInput.min), Number(animationWidthInput.max));
      animationHeightInput.value = clamp(animationHeightValue.value, Number(animationHeightInput.min), Number(animationHeightInput.max));
      animationXInput.value = clamp(animationXValue.value, Number(animationXInput.min), Number(animationXInput.max));
      animationYInput.value = clamp(animationYValue.value, Number(animationYInput.min), Number(animationYInput.max));
      syncLabels();
      broadcastStyle();
      renderSeatsPreview();
    }

    [heightInput, widthInput, gapInput, blendInput, plusSizeInput, labelSizeInput, camWidthInput, camHeightInput, camRadiusInput, camXInput, camYInput, closedCamWidthInput, closedCamHeightInput, closedCamXInput, closedCamYInput, roomWidthInput, roomHeightInput, roomRadiusInput, roomXInput, roomYInput, animationWidthInput, animationHeightInput, animationXInput, animationYInput, color1, color2].forEach((el) => {
      el.addEventListener("input", () => {
        syncLabels();
        broadcastStyle();
        renderSeatsPreview();
      });
    });

    if (requestStyleSelect) {
      requestStyleSelect.addEventListener("change", () => {
        broadcastStyle();
        renderSeatsPreview();
      });
    }

    if (pointsFormatSelect) {
      pointsFormatSelect.addEventListener("change", () => {
        broadcastStyle();
        renderSeatsPreview();
      });
    }

    [heightValue, widthValue, gapValue, blendValue, plusSizeValue, labelSizeValue, camWidthValue, camHeightValue, camRadiusValue, camXValue, camYValue, closedCamWidthValue, closedCamHeightValue, closedCamXValue, closedCamYValue, roomWidthValue, roomHeightValue, roomRadiusValue, roomXValue, roomYValue, animationWidthValue, animationHeightValue, animationXValue, animationYValue].forEach((el) => {
      el.addEventListener("input", () => {
        syncFromNumber();
      });
    });

    initChannel();
    hydrateFromStore();
    syncLabels();
    loadSeats();
    renderSeatsPreview();
    broadcastSeats();
    setRoomOpen(roomOpen);
    if (channel) {
      channel.addEventListener("message", (event) => handleRemoteMessage(event.data));
    } else {
      window.addEventListener("storage", (e) => {
        if (e.key === fallbackKey && e.newValue) {
          try { handleRemoteMessage(JSON.parse(e.newValue)); } catch (err) { /* ignore */ }
        }
        if (e.key === styleStoreKey) {
          hydrateFromStore();
        }
      });
    }
    window.addEventListener("storage", (e) => {
      if (e.key === styleStoreKey) {
        hydrateFromStore();
        // Do NOT broadcastStyle here ‚Äî it overwrites mode1's saved layout
      }
    });
    if (preferredMode === "remote") {
      // already remote
    }
  </script>
</body>
</html>
